<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>PsyOS RAG Chatbot</title>
    <link id="prismDark" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <link id="prismLight" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
    <style>
        :root {
            --bg: #0a0f1c; --panel: #141b2d; --panel-2: #1a2238; --text: #d1d7e0;
            --muted: #8b98b3; --brand: #5b4ce8; --brand-2: #6b5ce7; --success: #2dd4bf;
            --danger: #f87171; --border: #2a3447; --user-bubble: #2a3447;
            --assistant-bubble: #1f2a44; --code-bg: #0e1525; --shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        [data-theme="light"] {
            --bg: #f8fafc; --panel: #ffffff; --panel-2: #f1f5f9; --text: #1e293b;
            --muted: #64748b; --brand: #5b4ce8; --brand-2: #4c3ad6; --success: #14b8a6;
            --danger: #ef4444; --border: #e2e8f0; --user-bubble: #e0e7ff;
            --assistant-bubble: #f1f5f9; --code-bg: #f1f5f9; --shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        * { box-sizing: border-box; }
        html, body { height: 100%; margin: 0; }
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: radial-gradient(ellipse 1000px 600px at 85% -5%, rgba(91, 76, 232, 0.15), transparent),
                        radial-gradient(ellipse 1200px 800px at -15% -5%, rgba(45, 212, 191, 0.1), transparent),
                        var(--bg);
            color: var(--text); display: grid; grid-template-rows: auto 1fr;
            transition: background 0.3s ease;
        }
        header {
            display: flex; align-items: center; justify-content: space-between; padding: 12px 20px;
            border-bottom: 1px solid var(--border); backdrop-filter: blur(8px);
            background: linear-gradient(180deg, rgba(0,0,0,0.2), rgba(0,0,0,0.05)), var(--panel);
            position: sticky; top: 0; z-index: 10; box-shadow: var(--shadow);
        }
        .brand { display: flex; align-items: center; gap: 12px; }
        .brand-logo { width: 32px; height: 32px; border-radius: 8px; background: conic-gradient(from 200deg, var(--brand), var(--success)); box-shadow: 0 0 20px rgba(91, 76, 232, 0.3); transition: transform 0.3s ease; }
        .brand-logo:hover { transform: scale(1.05); }
        .brand h1 { font-size: 18px; font-weight: 600; margin: 0; letter-spacing: 0.2px; }
        .header-actions { display: flex; gap: 10px; align-items: center; }
        .btn, button { border: 1px solid var(--border); background: var(--panel-2); color: var(--text); padding: 8px 12px; border-radius: 8px; font-size: 13px; font-weight: 500; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; transition: background 0.2s ease, transform 0.2s ease; }
        .btn:hover:not(:disabled) { transform: translateY(-1px); }
        .btn.primary { background: linear-gradient(180deg, var(--brand), var(--brand-2)); border-color: transparent; color: #fff; }
        .btn.danger { background: linear-gradient(180deg, var(--danger), #dc2626); border-color: transparent; color: #fff; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        main { display: grid; grid-template-columns: 280px 1fr; gap: 20px; padding: 20px; max-width: 1400px; margin: 0 auto; width: 100%; height: 100%; overflow: hidden; }
        @media (max-width: 900px) { main { grid-template-columns: 1fr; gap: 12px; padding: 12px; } aside { display: none; } }
        aside { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 16px; height: 100%; overflow-y: auto; box-shadow: var(--shadow); scrollbar-width: thin; scrollbar-color: var(--muted) var(--panel); }
        .aside-title { font-size: 14px; font-weight: 500; color: var(--muted); margin-bottom: 10px; }
        .history { display: grid; gap: 8px; }
        .history-item { padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; background: var(--panel-2); font-size: 13px; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; transition: background 0.2s ease, transform 0.2s ease; }
        .history-item:hover { background: var(--brand); color: #fff; transform: translateY(-1px); }
        section.chat { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; display: grid; grid-template-rows: 1fr auto; height: 100%; box-shadow: var(--shadow); overflow: hidden; }
        .messages { padding: 20px; overflow-y: auto; scroll-behavior: smooth; scrollbar-width: thin; scrollbar-color: var(--muted) var(--panel); }
        .msg { display: grid; grid-template-columns: 32px 1fr; gap: 12px; margin-bottom: 16px; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .avatar { width: 32px; height: 32px; border-radius: 8px; background: var(--user-bubble); display: grid; place-items: center; font-size: 14px; font-weight: 500; color: var(--muted); flex-shrink: 0; }
        .bubble { padding: 0.1px 16px; border-radius: 12px; font-size: 14px; line-height: 1.6; word-wrap: break-word; overflow-wrap: break-word; }
        .msg.user .avatar { background: linear-gradient(180deg, var(--brand), var(--brand-2)); color: #fff; }
        .meta { font-size: 12px; font-weight: 500; color: var(--muted); margin-bottom: 8px; }
        .bubble pre { background: var(--code-bg) !important; border-radius: 8px; padding: 12px !important; margin: 12px 0; overflow-x: auto; font-size: 13px; line-height: 1.5; border: 1px solid var(--border); }
        .bubble code:not(pre > code) { background: var(--code-bg); padding: 2px 5px; border-radius: 4px; border: 1px solid var(--border); font-size: 0.9em; }
        .typing { display: inline-flex; gap: 4px; }
        .typing span { width: 8px; height: 8px; background: var(--muted); border-radius: 50%; display: inline-block; animation: blink 1.4s infinite; opacity: 0.5; }
        .typing span:nth-child(2) { animation-delay: 0.2s; }
        .typing span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes blink { 0%, 80%, 100% { opacity: 0.3; } 40% { opacity: 1; } }
        .composer { padding: 14px; border-top: 1px solid var(--border); background: var(--panel); border-radius: 0 0 12px 12px; }
        .input-wrap { display: flex; align-items: center; gap: 10px; background: var(--panel-2); border: 1px solid var(--border); border-radius: 10px; padding: 4px 4px 4px 12px; transition: border-color 0.2s ease; }
        .input-wrap:focus-within { border-color: var(--brand); }
        textarea { resize: none; border: none; outline: none; background: transparent; color: var(--text); font-size: 14px; font-family: inherit; width: 100%; height: 24px; max-height: 200px; line-height: 24px; padding: 0;}
        textarea::placeholder { color: var(--muted); }
        .toast { position: fixed; right: 20px; bottom: 20px; background: var(--panel); color: var(--text); border: 1px solid var(--border); padding: 12px 16px; border-radius: 8px; box-shadow: var(--shadow); display: none; font-size: 13px; max-width: 300px; animation: slideIn 0.3s ease; z-index: 20; }
        .toast.show { display: block; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <header>
        <div class="brand">
            <div class="brand-logo" aria-hidden="true"></div>
            <h1>PsyOS Assistant</h1>
        </div>
        <div class="header-actions">
            <a class="btn" href="./dashboard.html" title="Go to Dashboard">Dashboard</a>
            <button id="themeToggle" class="btn" title="Toggle theme">Theme</button>
            <button id="clearChat" class="btn danger" title="Clear conversation">Clear</button>
        </div>
    </header>

    <main>
        <aside>
            <div class="aside-title">Recent Chats</div>
            <div id="history" class="history"></div>
        </aside>

        <section class="chat" aria-live="polite">
            <div id="messages" class="messages"></div>

            <div class="composer">
                <div class="input-wrap">
                    <textarea id="input" placeholder="Ask a question about PsyOS..." rows="1"></textarea>
                    <button id="send" class="btn primary" title="Send (Enter)">Send</button>
                </div>
            </div>
        </section>
    </main>

    <div id="toast" class="toast" role="status"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.1.6/purify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.2/marked.min.js"></script>
    <script>
        const API_BASE_URL = 'http://localhost:5000';
        const messagesEl = document.getElementById('messages');
        const inputEl = document.getElementById('input');
        const sendBtn = document.getElementById('send');
        const clearBtn = document.getElementById('clearChat');
        const historyEl = document.getElementById('history');
        const toastEl = document.getElementById('toast');
        const themeToggle = document.getElementById('themeToggle');

        const SESSION_DURATION = 30 * 60 * 1000; // 30 minutes in milliseconds

        marked.setOptions({ gfm: true, breaks: true, langPrefix: 'language-' });
        let messages = loadMessages();
        let sending = false;

        // Initialize theme and render
        applyTheme(loadTheme());
        renderAll();

        // Event Listeners
        themeToggle.addEventListener('click', () => {
            const next = (document.documentElement.getAttribute('data-theme') === 'light') ? 'dark' : 'light';
            saveTheme(next);
            applyTheme(next);
        });

        clearBtn.addEventListener('click', () => {
            if (sending || messages.length === 0) return;
            if (confirm('Are you sure you want to clear this conversation?')) {
                messages = [];
                saveMessages();
                renderAll();
                showToast('Conversation cleared');
            }
        });

        sendBtn.addEventListener('click', () => trySend());

        inputEl.addEventListener('input', () => autoResize(inputEl));

        inputEl.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                trySend();
            }
        });

        // Render Functions
        function renderAll() {
            renderMessages();
            renderHistory();
            requestAnimationFrame(() => scrollToBottom());
        }

        function renderMessages() {
            messagesEl.innerHTML = '';
            if (messages.length === 0) {
                messagesEl.innerHTML = `<div style="text-align:center; color: var(--muted); padding-top: 20%;">Ask a question to get started.</div>`;
            } else {
                const fragment = document.createDocumentFragment();
                for (const m of messages) {
                    fragment.appendChild(renderMessage(m));
                }
                messagesEl.appendChild(fragment);
            }
            requestAnimationFrame(() => Prism.highlightAllUnder(messagesEl));
        }

        function renderHistory() {
            historyEl.innerHTML = '';
            const items = messages.filter(m => m.role === 'user').slice(-10).reverse();
            const fragment = document.createDocumentFragment();
            for (const it of items) {
                const div = document.createElement('div');
                div.className = 'history-item';
                div.title = it.text;
                div.textContent = it.text;
                div.onclick = () => {
                    inputEl.value = it.text;
                    inputEl.focus();
                    autoResize(inputEl);
                };
                fragment.appendChild(div);
            }
            historyEl.appendChild(fragment);
        }

        function renderMessage(m) {
            const wrap = document.createElement('div');
            wrap.className = 'msg ' + (m.role === 'user' ? 'user' : 'assistant');

            const avatar = document.createElement('div');
            avatar.className = 'avatar';
            avatar.textContent = m.role === 'user' ? 'U' : 'P';

            const content = document.createElement('div');
            content.style.minWidth = '0'; // Fix for text overflow

            const meta = document.createElement('div');
            meta.className = 'meta';
            const ts = new Date(m.ts || Date.now());
            meta.textContent = (m.role === 'user' ? 'You' : 'PsyOS Assistant') + ' â€¢ ' + ts.toLocaleTimeString();

            const bubble = document.createElement('div');
            bubble.className = 'bubble';

            if (m.role === 'assistant') {
                try {
                    const rawHtml = marked.parse(m.text || '');
                    bubble.innerHTML = DOMPurify.sanitize(rawHtml, { USE_PROFILES: { html: true } });
                } catch (e) {
                    bubble.textContent = m.text;
                }
            } else {
                bubble.textContent = m.text;
            }

            content.appendChild(meta);
            content.appendChild(bubble);
            wrap.appendChild(avatar);
            wrap.appendChild(content);
            return wrap;
        }

        function showTyping() {
            const wrap = document.createElement('div');
            wrap.className = 'msg assistant';
            wrap.id = 'typing';

            const avatar = document.createElement('div');
            avatar.className = 'avatar';
            avatar.textContent = 'P';

            const content = document.createElement('div');
            const meta = document.createElement('div');
            meta.className = 'meta';
            meta.textContent = 'Assistant is typing...';

            const bubble = document.createElement('div');
            bubble.className = 'bubble';
            const dots = document.createElement('div');
            dots.className = 'typing';
            dots.innerHTML = '<span></span><span></span><span></span>';

            bubble.appendChild(dots);
            content.appendChild(meta);
            content.appendChild(bubble);
            wrap.appendChild(avatar);
            wrap.appendChild(content);
            messagesEl.appendChild(wrap);
            requestAnimationFrame(() => scrollToBottom());
        }

        function hideTyping() {
            const t = document.getElementById('typing');
            if (t) t.remove();
        }

        function setSending(v) {
            sending = v;
            sendBtn.disabled = v;
            inputEl.disabled = v;
        }

        async function trySend() {
            const text = inputEl.value.trim();
            if (!text || sending) {
                return;
            }

            setSending(true);
            const userMsg = { role: 'user', text, ts: Date.now() };
            messages.push(userMsg);

            if (messages.length === 1) messagesEl.innerHTML = '';

            messagesEl.appendChild(renderMessage(userMsg));
            renderHistory();
            inputEl.value = '';
            autoResize(inputEl);
            showTyping();

            try {
                const res = await fetch(`${API_BASE_URL}/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: text })
                });

                const data = await res.json();
                hideTyping();

                if (!res.ok || data.error) {
                    throw new Error(data.error || `HTTP ${res.status}`);
                }

                const botMsg = {
                    role: 'assistant',
                    text: (data.response ?? JSON.stringify(data)),
                    ts: Date.now()
                };
                messages.push(botMsg);
                saveMessages();

                const msgElement = renderMessage(botMsg);
                messagesEl.appendChild(msgElement);

                // Highlight code in the new message only
                requestAnimationFrame(() => {
                    Prism.highlightAllUnder(msgElement);
                    scrollToBottom();
                });

            } catch (e) {
                hideTyping();
                const errMsg = {
                    role: 'assistant',
                    text: `**Error:** ${e.message}`,
                    ts: Date.now()
                };
                messages.push(errMsg);
                messagesEl.appendChild(renderMessage(errMsg));
                showToast('Error: ' + e.message);
            } finally {
                setSending(false);
                inputEl.focus();
                requestAnimationFrame(() => scrollToBottom());
            }
        }

        function autoResize(el) {
            el.style.height = 'auto';
            el.style.height = Math.min(el.scrollHeight, 200) + 'px';
        }

        function scrollToBottom() {
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        function showToast(msg) {
            toastEl.textContent = msg;
            toastEl.classList.add('show');
            setTimeout(() => toastEl.classList.remove('show'), 3000);
        }

        // Storage Functions with 30-minute expiry
        function saveMessages() {
            try {
                const data = {
                    messages: messages,
                    timestamp: Date.now()
                };
                localStorage.setItem('chat_session', JSON.stringify(data));
            } catch (e) {
                console.error('Failed to save messages:', e);
            }
        }

        function loadMessages() {
            try {
                const raw = localStorage.getItem('chat_session');
                if (!raw) return [];

                const data = JSON.parse(raw);
                const currentTime = Date.now();

                // Check if session is expired (older than 30 minutes)
                if (currentTime - data.timestamp > SESSION_DURATION) {
                    localStorage.removeItem('chat_session');
                    return [];
                }

                return data.messages || [];
            } catch (e) {
                console.error('Failed to load messages:', e);
                return [];
            }
        }

        function saveTheme(t) {
            localStorage.setItem('chat_theme', t);
        }

        function loadTheme() {
            return localStorage.getItem('chat_theme') || 'dark';
        }

        function applyTheme(t) {
            document.documentElement.setAttribute('data-theme', t);
            const isLight = t === 'light';
            document.getElementById('prismLight').disabled = !isLight;
            document.getElementById('prismDark').disabled = isLight;
        }

        // Periodic cleanup - check session expiry every minute
        setInterval(() => {
            const raw = localStorage.getItem('chat_session');
            if (raw) {
                try {
                    const data = JSON.parse(raw);
                    if (Date.now() - data.timestamp > SESSION_DURATION) {
                        localStorage.removeItem('chat_session');
                        messages = [];
                        renderAll();
                        showToast('Chat session expired (30 minutes)');
                    }
                } catch (e) {
                    console.error('Error checking session expiry:', e);
                }
            }
        }, 60000); // Check every minute
    </script>
</body>
</html>